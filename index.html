<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="注音練習" />
<title>注音練習（互動）</title>
<style>
  :root{
    --bg:#f6f8ff;
    --glass-bg: rgba(255,255,255,0.55);
    --glass-border: rgba(255,255,255,0.6);
    --accent:#ff7ab6;
    --accent2:#7aa2ff;
    --shadow: 0 8px 20px rgba(50,50,90,0.08);
    --radius:14px;
    --kbd-radius:18px;
    --safe-bottom: env(safe-area-inset-bottom, 12px);
    --safe-top: env(safe-area-inset-top, 12px);
  }
  html,body{
    height:100%;
    margin:0;
    font-family: "Noto Sans TC", system-ui, -apple-system, "Helvetica Neue", Arial;
    background: linear-gradient(180deg,#f0f4ff 0%, #fff 100%);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  /* Container that keeps top area & keyboard */
  .app {
    min-height:100dvh; /* try to mitigate mobile address bar */
    display:flex;
    flex-direction:column;
    align-items:stretch;
    justify-content:flex-end;
    padding: max(16px, env(safe-area-inset-top)) 12px calc(12px + var(--safe-bottom)) 12px;
    box-sizing:border-box;
  }

  /* Display area (top) */
  .display {
    margin-bottom:12px;
    background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.35));
    border-radius: var(--radius);
    padding: 18px;
    box-shadow: var(--shadow);
    backdrop-filter: blur(8px) saturate(120%);
    border: 1px solid var(--glass-border);
    min-height:120px;
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .display .line {
    display:flex;
    align-items:center;
    justify-content:space-between;
  }
  .display .phonetic {
    font-size: 34px;
    letter-spacing:6px;
    font-weight:700;
    color:#333;
  }
  .display .selected-char {
    font-size:48px;
    font-weight:800;
    color:var(--accent);
    text-shadow: 0 6px 22px rgba(255,122,182,0.12);
  }
  .display .helper {
    font-size:13px;
    color:#666;
  }

  /* Candidate bar (like IME) */
  .candidates {
    margin-top:8px;
    display:flex;
    flex-wrap:nowrap;
    gap:8px;
    overflow:auto;
  }
  .candidate {
    padding:8px 12px;
    border-radius:12px;
    background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(250,250,255,0.8));
    border:1px solid rgba(0,0,0,0.06);
    box-shadow: 0 6px 18px rgba(60,60,90,0.04);
    font-weight:700;
    min-width:44px;
    text-align:center;
    cursor:pointer;
  }

  /* Keyboard */
  .keyboard {
    background: linear-gradient(180deg, rgba(255,255,255,0.45), rgba(255,255,255,0.25));
    border-radius: calc(var(--kbd-radius) + 6px);
    padding:12px;
    box-shadow: 0 12px 30px rgba(30,30,60,0.08);
    border:1px solid var(--glass-border);
    backdrop-filter: blur(10px) saturate(120%);
  }
  .keys-grid {
    display:grid;
    grid-template-columns: repeat(8, 1fr);
    gap:8px;
  }
  .key {
    background: linear-gradient(180deg, rgba(255,255,255,0.85), rgba(250,250,255,0.75));
    border-radius:12px;
    padding:12px 8px;
    text-align:center;
    font-size:20px;
    font-weight:700;
    cursor:pointer;
    border:1px solid rgba(0,0,0,0.04);
    user-select:none;
    transition: transform 0.12s ease, box-shadow 0.12s ease;
    box-shadow: 0 6px 16px rgba(30,30,60,0.04);
  }
  .key:active { transform: translateY(3px) scale(0.995); box-shadow:none; }
  .key.small { font-size:16px; padding:8px; border-radius:10px }
  .key.func {
    background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(245,245,255,0.9));
    border: 1px solid rgba(0,0,0,0.06);
    color:#333;
  }
  .key.accent {
    background: linear-gradient(180deg, var(--accent), rgba(255,122,182,0.85));
    color:white;
    font-weight:800;
    font-size:18px;
    box-shadow: 0 8px 28px rgba(255,110,170,0.12);
  }

  .row {
    display:flex;
    gap:8px;
    margin-bottom:8px;
  }

  /* Device-aware: tablet wide layout */
  @media (min-width:720px){
    .app { padding:24px; }
    .container-wide {
      max-width:980px;
      margin:0 auto;
      align-self:center;
      width:100%;
    }
    .display {
      min-height:160px;
      padding:20px;
    }
    .keys-grid { grid-template-columns: repeat(12, 1fr); }
  }

  /* small tweaks */
  .controls { display:flex; gap:10px; align-items:center; }
  .btn {
    padding:8px 12px;
    border-radius:12px;
    border:1px solid rgba(0,0,0,0.06);
    background:linear-gradient(180deg,#fff,#fafafa);
    cursor:pointer;
    font-weight:700;
  }

  .hint {
    font-size:12px;
    color:#777;
  }

  /* simple focus styles for accessibility */
  .key:focus { outline: 2px solid rgba(122,162,255,0.25); outline-offset:2px; }
</style>
</head>
<body>
<div class="app" id="app">
  <div class="container-wide">
    <div class="display" role="region" aria-label="注音顯示區">
      <div class="line">
        <div class="phonetic" id="phoneticDisplay">　</div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
          <div class="selected-char" id="charDisplay">　</div>
          <div class="helper hint" id="toneHint">點擊注音鍵盤來輸入，候選字會自動出現</div>
        </div>
      </div>
      <div class="candidates" id="candidates" aria-live="polite"></div>
    </div>

    <div class="keyboard" id="keyboard" role="application" aria-label="注音鍵盤">
      <!-- functional row -->
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="controls">
          <button class="btn" id="enterCandidate">確定字</button>
          <button class="btn" id="readBtn">讀音</button>
          <button class="btn" id="clearBtn">清除</button>
        </div>
        <div class="hint">玻璃風｜自動候選字</div>
      </div>

      <!-- keys grid -->
      <div class="keys-grid" id="keysGrid" tabindex="0" role="grid">
        <!-- keys will be injected -->
      </div>

    </div>
  </div>
</div>

<script>
/*
  注音互動式網頁 App
  - 使用簡單本地候選字典（可擴充）
  - 使用 Web Speech Synthesis 唸出示例字或選字
  - Clear 不會發聲（依使用者需求）
  - 設計嘗試讓 iOS 瀏覽器可隱藏網址列（需 user gesture 或加入主畫面）
*/

/* ---------- 基本資料 ----------- */
/* 注音鍵位：排列成常見的注音鍵盤順序（包含聲母、韻母、輔助符號） */
const keyRows = [
  ['ㄅ','ㄆ','ㄇ','ㄈ','ㄉ','ㄊ','ㄋ','ㄌ'],
  ['ㄍ','ㄎ','ㄏ','ㄐ','ㄑ','ㄒ','ㄓ','ㄔ'],
  ['ㄕ','ㄖ','ㄗ','ㄘ','ㄙ','ㄧ','ㄨ','ㄩ'],
  ['ㄚ','ㄛ','ㄜ','ㄝ','ㄞ','ㄟ','ㄠ','ㄡ'],
  ['ㄢ','ㄣ','ㄤ','ㄥ','ㄦ','˙','ˊ','ˇ'],
  ['ˋ','空格','退格','候選','語音','（示例）','　','　']
];

/* 示例字（用來唸出按的注音）——用常見字做 mnemonic，避免直接唸符號導致怪音 */
const sampleMap = {
  'ㄅ':'波','ㄆ':'坡','ㄇ':'摸','ㄈ':'發','ㄉ':'的','ㄊ':'他','ㄋ':'那','ㄌ':'拉',
  'ㄍ':'哥','ㄎ':'科','ㄏ':'哈','ㄐ':'吉','ㄑ':'起','ㄒ':'西','ㄓ':'之','ㄔ':'吃',
  'ㄕ':'是','ㄖ':'日','ㄗ':'子','ㄘ':'次','ㄙ':'思','ㄧ':'一','ㄨ':'屋','ㄩ':'魚',
  'ㄚ':'阿','ㄛ':'喔','ㄜ':'鵝','ㄝ':'耶','ㄞ':'愛','ㄟ':'欸','ㄠ':'好','ㄡ':'歐',
  'ㄢ':'安','ㄣ':'恩','ㄤ':'昂','ㄥ':'鷹','ㄦ':'兒',
  '˙':'輕聲','ˊ':'第二聲','ˇ':'第三聲','ˋ':'第四聲'
};

/* 簡易候選字典：key = 注音字串（不含 tone 或含 tone），value = array of 常用字 */
const candidatesDict = {
  'ㄅㄚ': ['爸','吧','八'],
  'ㄅㄧ': ['比','筆','彼'],
  'ㄅㄛ': ['波','播','補'],
  'ㄇㄚ': ['麻','媽','馬'],
  'ㄇㄧ': ['米','迷','密'],
  'ㄨㄛ': ['我','握','臥'],
  'ㄋㄧ': ['你','泥','倪'],
  'ㄋㄚ': ['那','拿','納'],
  'ㄊㄚ': ['他','她','它'],
  'ㄊㄧ': ['提','體','踢'],
  'ㄊㄨ': ['土','徒','吐'],
  'ㄏㄠ': ['好','號','浩'],
  'ㄅㄤ': ['幫','棒','邦'],
  'ㄍㄨㄤ': ['光','廣'],
  'ㄑㄧㄥ': ['青','輕','情'],
  // 你可以在這裡新增更多映射（見下方說明）
};

/* app state */
let currentPhonetic = ''; // 拼音用注音符號組合
let selectedChar = ''; // 已點選的國字（若有）
let currentCandidates = [];

/* elements */
const phoneticDisplay = document.getElementById('phoneticDisplay');
const charDisplay = document.getElementById('charDisplay');
const candidatesEl = document.getElementById('candidates');
const keysGrid = document.getElementById('keysGrid');
const readBtn = document.getElementById('readBtn');
const clearBtn = document.getElementById('clearBtn');
const enterCandidate = document.getElementById('enterCandidate');

/* 初始鍵盤注入 */
function buildKeys(){
  // flatten rows into a simple keys list (preserve spacing)
  keyRows.flat().forEach(k=>{
    const but = document.createElement('button');
    but.className = 'key';
    if(k==='空格'){ but.textContent='空格'; but.classList.add('func'); }
    else if(k==='退格'){ but.textContent='退格'; but.classList.add('func'); }
    else if(k==='候選'){ but.textContent='候選'; but.classList.add('func'); }
    else if(k==='語音'){ but.textContent='語音'; but.classList.add('accent'); }
    else if(k==='（示例）'){ but.textContent='示例'; but.classList.add('small'); }
    else { but.textContent = k; }
    but.setAttribute('data-key',k);
    but.addEventListener('click', onKeyPress);
    keysGrid.appendChild(but);
  });
}
buildKeys();

/* 更新顯示 */
function refreshDisplay(){
  phoneticDisplay.textContent = currentPhonetic || '　';
  charDisplay.textContent = selectedChar || '　';
  renderCandidates();
}

/* 產生候選字（像輸入法）——每次 currentPhonetic 變更就找候選 */
function renderCandidates(){
  candidatesEl.innerHTML = '';
  currentCandidates = [];
  if(!currentPhonetic) return;
  // 1) 先嘗試直接以整串拼音去找
  const key = currentPhonetic.replace(/\s+/g,'');
  if(candidatesDict[key]){
    currentCandidates = candidatesDict[key].slice(0,12);
  } else {
    // 2) 嘗試移除 tone 符號（示簡化）
    const noTone = key.replace(/[˙ˊˇˋ]/g,'');
    if(candidatesDict[noTone]) currentCandidates = candidatesDict[noTone].slice(0,12);
  }
  // 3) render
  if(currentCandidates.length){
    currentCandidates.forEach(ch=>{
      const item = document.createElement('div');
      item.className='candidate';
      item.textContent = ch;
      item.addEventListener('click', ()=> {
        selectedChar = ch;
        // 當選字之後就不需要再用注音唸拼音（使用者需求：選好國字唸國字以避免怪音）
        refreshDisplay();
        speakText(ch, {forceLang:'zh-TW'});
      });
      candidatesEl.appendChild(item);
    });
  } else {
    // 顯示提示字元（如沒有候選）
    const hint = document.createElement('div');
    hint.className='candidate';
    hint.textContent = '無候選';
    candidatesEl.appendChild(hint);
  }
}

/* 鍵盤事件處理 */
function onKeyPress(e){
  const key = e.currentTarget.getAttribute('data-key');
  if(!key) return;
  if(key === '空格'){
    // 決定空格為提交一個字的分隔
    // 送出目前拼音（模擬輸入完一個字），但保持 currentPhonetic 以供候選
    // 這裡我們不自動清除拼音（讓使用者選字）
    speakPhoneticKey('空格'); // optional
    return;
  }
  if(key === '退格'){
    // backspace: 刪除最後一個注音符號或清除選字
    if(selectedChar){
      selectedChar = '';
    } else if(currentPhonetic.length){
      currentPhonetic = currentPhonetic.slice(0,-1);
    }
    refreshDisplay();
    return;
  }
  if(key === '候選'){
    // 顯示候選（已由 render 自動更新）—這個按鈕可作為提示
    renderCandidates();
    return;
  }
  if(key === '語音'){
    // 唸出目前拼好的字或選字
    readPronunciation();
    return;
  }
  if(key === '示例'){
    // 讀說明（示例）
    speakText('按鍵會唸出注音的示例發音；選好國字再按讀音，可以得到正確的國字發音。', {forceLang:'zh-TW'});
    return;
  }

  // 正常注音鍵：加入拼音串，清除已選國字（若之前已選字則代表在開始新拼音）
  if(selectedChar) selectedChar = '';
  currentPhonetic += key;
  // 當按鍵時要唸出該按鍵（使用 sampleMap）
  speakPhoneticKey(key);
  refreshDisplay();
}

/* 按下確定字：若有候選則把第一個當結果（或使用者可以點候選） */
enterCandidate.addEventListener('click', ()=>{
  if(currentCandidates.length){
    selectedChar = currentCandidates[0];
    // 取得選字且唸讀
    refreshDisplay();
    speakText(selectedChar,{forceLang:'zh-TW'});
  } else {
    // 沒有候選：稍微提示
    speakText('沒有候選字','zh-TW');
  }
});

/* 清除鍵（**不**發語音） */
clearBtn.addEventListener('click', ()=>{
  currentPhonetic = '';
  selectedChar = '';
  currentCandidates = [];
  refreshDisplay();
});

/* 讀音按鈕（唸出已選國字或拼好的注音） */
readBtn.addEventListener('click', readPronunciation);

function readPronunciation(){
  if(selectedChar){
    speakText(selectedChar, {forceLang:'zh-TW'});
  } else if (currentPhonetic){
    // 嘗試用候選字來唸（若有候選就唸第一個），否則用示例字來唸拼音的每個符號（避免怪音）
    if(currentCandidates.length){
      speakText(currentCandidates[0], {forceLang:'zh-TW'});
    } else {
      // 將注音拆解為示例字串來唸
      const seq = Array.from(currentPhonetic).map(ch => sampleMap[ch] || ch).join('，');
      speakText(seq, {forceLang:'zh-TW'});
    }
  } else {
    speakText('請先輸入注音', {forceLang:'zh-TW'});
  }
}

/* ---------- 語音相關 ---------- */
function speakText(text, opts = {}){
  if(!('speechSynthesis' in window)) return; // browser not support
  const synth = window.speechSynthesis;
  // cancel pending only for read actions (we don't cancel on key press to allow overlap)
  // but small devices may want to cancel previous read; leave default
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = opts.forceLang || 'zh-TW';
  // 可調語速、音高
  utter.rate = opts.rate || 0.95;
  utter.pitch = opts.pitch || 1.0;
  synth.speak(utter);
}

/* 當按下注音鍵時唸出示例字，但避免打斷主讀音 (不取消現有 speech) */
function speakPhoneticKey(key){
  const sample = sampleMap[key];
  if(sample){
    // speak example char
    speakText(sample, {forceLang:'zh-TW', rate:1.0});
  } else {
    // fallback speak the key as text (may be read oddly)
    // do nothing
  }
}

/* ---------- 裝置偵測與版面微調 ---------- */
function applyDeviceLayout(){
  const w = window.innerWidth;
  const isTablet = w >= 720;
  const app = document.getElementById('app');
  if(isTablet){
    // For tablet, make keyboard wider and larger fonts
    document.documentElement.style.setProperty('--kbd-radius','22px');
    phoneticDisplay.style.fontSize = '36px';
    charDisplay.style.fontSize = '56px';
  } else {
    document.documentElement.style.setProperty('--kbd-radius','18px');
    phoneticDisplay.style.fontSize = '34px';
    charDisplay.style.fontSize = '48px';
  }
}
window.addEventListener('resize', applyDeviceLayout);
applyDeviceLayout();

/* 嘗試進入全螢幕（必須由 user gesture） */
/* 我們在第一次點擊鍵盤時嘗試開啟 full screen，以協助隱藏地址列（僅在支援的瀏覽器有效） */
let fullscreenAttempted = false;
document.getElementById('keyboard').addEventListener('click', async function tryFull(){
  if(fullscreenAttempted) return;
  fullscreenAttempted = true;
  const el = document.documentElement;
  try {
    if (el.requestFullscreen) await el.requestFullscreen();
    else if (el.webkitRequestFullscreen) await el.webkitRequestFullscreen();
    // some browsers will ignore; iOS Safari doesn't allow programmatic fullscreen, so instruct user
  } catch(e){
    // ignored
  }
});

/* Accessibility: keyboard navigation (簡單) */
keysGrid.addEventListener('keydown', (e)=>{
  // allow Enter to activate focused key
  if(e.key === 'Enter' && document.activeElement && document.activeElement.classList.contains('key')){
    document.activeElement.click();
  }
});

/* 初次載入顯示預設 */
refreshDisplay();

/* ---------- 開發者與使用說明（內建說明） ---------- */
/*
  擴充候選字字典:
  - 在 candidatesDict 裡新增 key 為注音串（例如 'ㄋㄧ'），value 為字陣列 ['你','尼',...]
  - app 會在使用者輸入的 currentPhonetic 完整匹配時顯示候選（也會嘗試去掉聲調符號）
  - 若需更完整的輸入法功能，建議連接後端注音->字庫 API 或使用較大的本地字典檔（JSON）

  iOS 建議:
  - 在 iOS Safari 上，若要完全隱藏網址列/功能列，請將網頁「加入主畫面」(Add to Home Screen)。
  - PWA manifest + https + service worker 可讓使用者安裝為 app，進一步隱藏 chrome/地址列。

  相容性:
  - 本方案使用 Web Speech API：大部分現代手機瀏覽器支援，但某些舊手機或瀏覽器可能不支援。
  - 若目標一定要兼容非常舊的系統，建議提供「發音檔」(mp3) 的備援，或在不支援時顯示提示。

  其他可服務的擴充:
  - 加入「聲調按鍵」更精確處理聲調拼音
  - 將候選字字庫換成大型詞庫或向量化搜尋以支援多字詞
  - 儲存使用者常用字（我的最愛）
*/

</script>
</body>
</html>
